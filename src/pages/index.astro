---
import countBy from 'lodash/countBy';
import orderBy from 'lodash/orderBy';
import intersection from 'lodash/intersection';
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { MainPage } from '../templates/MainPage';
import { recipeEntryToRecipe } from '../util/recipeEntryToRecipe';
import type { Recipe } from '../types/Recipe';
import { SEASONS } from '../util/olivier/regions/valencia';

const MEAL_TAGS = ['Lunch', 'Dinner', 'Breakfast', 'Brunch'];

const entries = await getCollection('recipes');
const allRecipes = entries.map((x) => recipeEntryToRecipe(x));

const CURRENT_SEASON = new Date().getMonth() + 1;
const NEXT_SEASON = CURRENT_SEASON === 12 ? 1 : CURRENT_SEASON + 1;
const NEW_RECIPES_TO_SHOW = 6;

function getNewRecipes(recipes: Recipe[]): Recipe[] {
	return orderBy(recipes, (x) => -x.createdAt).slice(0, NEW_RECIPES_TO_SHOW);
}

// Order recipes by the lengths of the seasons list:
// recipes with shorter season first, and discard foundational recipes
function getRecipesInSeason(recipes: Recipe[], seasonMonth: number): Recipe[] {
	return orderBy(
		recipes
			.filter((x) => x.seasons.includes(seasonMonth))
			.filter((x) => x.tags.includes('Foundation') === false),
		(x) => x.seasons.length
	);
}

function getIngredientsInSeason(seasonMonth: number) {
	const inSeason = Object.entries(SEASONS).filter(([, months]) =>
		months.includes(seasonMonth)
	);
	return inSeason.map(([ingredient]) => ingredient);
}

// Recipes under 30 minutes
function getQuickRecipes(recipes: Recipe[]) {
	return orderBy(
		recipes
			.filter((x) => (x.time ?? Infinity) <= 30)
			.filter((x) => intersection(x.tags, MEAL_TAGS).length > 0),
		(x) => x.time
	);
}

function getFavoriteRecipes(recipes: Recipe[]) {
	return orderBy(
		recipes.filter((x) => x.favorite),
		(x) => x.seasons.length
	);
}

function getCuisines(recipes: Recipe[]) {
	const allCuisines = recipes
		.flatMap((x) => x.cuisines)
		.filter((x) => x !== 'Klatzlandian');
	return orderBy(Object.entries(countBy(allCuisines)), (x) => -x[1]);
}

function getMeals(recipes: Recipe[]) {
	const allTags = recipes
		.flatMap((x) => x.tags)
		.filter((x) => MEAL_TAGS.includes(x));
	return orderBy(Object.entries(countBy(allTags)), (x) => -x[1]);
}

function getTags(recipes: Recipe[]) {
	const allTags = recipes
		.flatMap((x) => x.tags)
		.filter((x) => MEAL_TAGS.includes(x) === false);
	return orderBy(Object.entries(countBy(allTags)), (x) => -x[1]);
}
---

<Layout
	url="/"
	pageTitle="Tacohuaco: favorite recipes of a Mexican-Russian couple"
	component={MainPage}
	props={{
		newRecipes: getNewRecipes(allRecipes),
		recipesInSeason: getRecipesInSeason(allRecipes, CURRENT_SEASON),
		recipesNextSeason: getRecipesInSeason(allRecipes, NEXT_SEASON),
		favoriteRecipes: getFavoriteRecipes(allRecipes),
		quickRecipes: getQuickRecipes(allRecipes),
		ingredientsInSeason: getIngredientsInSeason(CURRENT_SEASON),
		ingredientsNextSeason: getIngredientsInSeason(NEXT_SEASON),
		cuisines: getCuisines(allRecipes),
		meals: getMeals(allRecipes),
		tags: getTags(allRecipes),
	}}
/>
