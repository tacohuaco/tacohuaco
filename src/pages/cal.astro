---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { CalendarPage } from '../templates/CalendarPage';
import { recipeEntryToRecipe } from '../util/recipeEntryToRecipe';
import { SEASONS } from '../util/olivier/regions/valencia';
import { ALL_MONTHS, Month, MONTH_NAMES } from '../util/olivier';
import { Page } from '../templates/Page';

const recipeEntries = await getCollection('recipes');
const allRecipes = recipeEntries.map((x) => recipeEntryToRecipe(x));

const calendarMonthsEntries = await getCollection('calendarMonths');
const allCalendarMonths = calendarMonthsEntries.map((x) => ({
	...x.data,
}));

function getIngredientsInSeason(seasonMonth: Month): string[] {
	const inSeason = Object.entries(SEASONS).filter(([, months]) =>
		months.includes(seasonMonth)
	);
	return inSeason.map(([ingredient]) => ingredient);
}

const months = ALL_MONTHS.map((month) => ({
	monthName: MONTH_NAMES[month],
	ingredients: getIngredientsInSeason(month),
	...allCalendarMonths.find((x) => x.month === month),
}));
---

<Layout url="/cal/" title="Calendar">
	<Page url="/cal/">
		<CalendarPage
			url="/cal"
			title="Calendar"
			months={months}
			allRecipes={allRecipes}
			client:load
		/>
	</Page>
</Layout>
